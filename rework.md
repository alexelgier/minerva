# Minerva Rework Plan: Agent Authority & Workflow Realignment

---

## Purpose

This document defines the target architecture and a concrete rework plan to realign Minerva with **strict separation of concerns**.

- **Chat and agents** express intent and answer questions.
- **Temporal workflows** own causality and orchestration.
- **The curation database** is the source of truth for pending/approved items.
- **The curation UI** is the approval surface where humans review and commit changes.
- **Notifications** are first-class system events.

This is not a rewrite. It is an **authority and permission refactor**.

---

## Core Design Invariants (Non-Negotiable)

### Invariant 1 — Agents must not mutate durable state

LangGraph agents (`minerva_agent`) **must not**:

- write or edit Obsidian files
- move or delete files
- write to Neo4j
- write to the SQLite curation DB

Agents **may only**:

- read files and databases
- propose actions as structured data
- explain, summarize, or analyze state
- **launch Temporal workflows** via tool calls

> If an agent can cause side effects, the architecture is incorrect.

### Invariant 2 — All irreversible actions occur inside Temporal activities

Any filesystem write, file move, database insert/update, or curation state transition **must occur only inside a Temporal activity**.

> If an action did not occur in Temporal, it did not happen.

### Invariant 3 — Curation UI is the approval surface

Human approval:

- lives exclusively in the curation UI (Vue.js)
- mutates the curation DB (accept/reject)
- unblocks Temporal workflow waits

**Chat UI is for launching workflows, not approving workflow steps.**

### Invariant 4 — Chat UI can start workflows (with mandatory HITL confirmation)

Chat can:

- **Start workflows** via tool calls (e.g., `start_concept_extraction(content_uuid="...")`)
- **Must confirm with user before launching** (HITL interrupt in chat)
- Query workflow status
- Answer questions, read files, explain proposals

Chat **cannot**:

- Approve individual workflow steps (that's the curation UI)
- Execute mutations directly
- Launch workflows without user confirmation

### Invariant 5 — Notifications are derived from state transitions

Notifications are:

- generated by the system
- stored in the curation DB
- triggered by workflow or curation state changes
- consumed by chat UI and curation UI

**Notifications are not authored by the LLM.**

---

## Current State Inventory

### Violations by Component

| Component | Violation | Location | Severity |
|-----------|-----------|----------|----------|
| `minerva_agent` | `deepagents.FilesystemBackend` includes `write_file`, `edit_file`, `move_file`, `delete_file` by default | `agent.py:52-56` | **High** |
| `zettel` Phase 3 | `create_concepts_db()` writes directly to Neo4j | `concept_extraction_graph.py:930-964` | **High** |
| `zettel` Phase 3 | `create_relations_db()` writes directly to Neo4j | `concept_extraction_graph.py:967-1007` | **High** |
| `zettel` Phase 3 | `create_obsidian_files()` writes directly to filesystem | `concept_extraction_graph.py:1049-1112` | **High** |
| `zettel` Phase 3 | `create_supports_relations()` writes directly to Neo4j | `concept_extraction_graph.py:1010-1046` | **High** |
| `zettel` | Uses LangGraph `interrupt()` for approval instead of curation DB | `concept_extraction_graph.py:848-870` | **Medium** |
| `quote_parse_graph` | Writes Content, Quote, Author nodes directly to Neo4j | `quote_parse_graph.py` | **High** |

### Components Already Compliant

| Component | Status | Notes |
|-----------|--------|-------|
| Journal Pipeline (Temporal) | ✅ Compliant | LLM extracts → curation DB → human approval via UI → Temporal activity writes |
| Vue.js Curation UI | ✅ Compliant | Only mutates via API endpoints, human-triggered |

---

## Target Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              MINERVA SYSTEM                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                     minerva-desktop (Chat UI)                         │   │
│  │  • Conversational interface (answer questions, explain things)        │   │
│  │  • Workflow launching via tool calls                                  │   │
│  │  • HITL confirmation before launching workflows                        │   │
│  │  • Query workflow status, read notifications                          │   │
│  │  • Built-in interrupt rendering (agent-chat-ui components)            │   │
│  │  • NO approval of workflow steps here                                 │   │
│  └────────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                          │
│                    start_workflow(...)                                       │
│                                   │                                          │
│                                   ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                    Temporal.io Orchestrator                           │   │
│  │                                                                       │   │
│  │  ┌──────────────────────────────────────────────────────────────┐    │   │
│  │  │  JournalProcessingWorkflow (existing)                         │    │   │
│  │  │  • Extract entities → curation DB → wait → write to Neo4j     │    │   │
│  │  └──────────────────────────────────────────────────────────────┘    │   │
│  │                                                                       │   │
│  │  ┌──────────────────────────────────────────────────────────────┐    │   │
│  │  │  QuoteParsingWorkflow (NEW - migrate from quote_parse_graph)  │    │   │
│  │  │  • Parse markdown → curation DB → wait → write to Neo4j       │    │   │
│  │  └──────────────────────────────────────────────────────────────┘    │   │
│  │                                                                       │   │
│  │  ┌──────────────────────────────────────────────────────────────┐    │   │
│  │  │  ConceptExtractionWorkflow (NEW - migrate from zettel)        │    │   │
│  │  │  • Extract concepts → curation DB → wait → write to Neo4j     │    │   │
│  │  │  • Create Obsidian files for approved concepts                │    │   │
│  │  └──────────────────────────────────────────────────────────────┘    │   │
│  │                                                                       │   │
│  │  ┌──────────────────────────────────────────────────────────────┐    │   │
│  │  │  InboxClassificationWorkflow (NEW)                            │    │   │
│  │  │  • Scan inbox → classify notes → curation DB → wait           │    │   │
│  │  │  • Move approved notes to target folders                      │    │   │
│  │  └──────────────────────────────────────────────────────────────┘    │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                   │                                          │
│                    polls / waits for approval                                │
│                                   │                                          │
│                                   ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                     Curation DB (SQLite)                              │   │
│  │  Tables:                                                             │   │
│  │  • journal_curation, entity_curation_items (existing)               │   │
│  │  • quote_curation_items (NEW)                                       │   │
│  │  • concept_curation_items (NEW)                                     │   │
│  │  • inbox_classification_items (NEW)                                 │   │
│  │  • notifications (NEW)                                              │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                   ▲                                          │
│                    approve / reject                                          │
│                                   │                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                     Curation UI (Vue.js)                              │   │
│  │  • Review pending entities, relationships, concepts, files           │   │
│  │  • Accept / Reject / Edit                                            │   │
│  │  • THIS is the approval surface                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                     LangGraph Agent (Read-Only + Launch)              │   │
│  │                                                                       │   │
│  │  minerva_agent:                                                       │   │
│  │  • read_file, list_dir, glob, grep (safe, no approval)              │   │
│  │  • start_quote_parsing (launches Temporal) [HITL required]          │   │
│  │  • start_concept_extraction (launches Temporal) [HITL required]     │   │
│  │  • start_inbox_classification (launches Temporal) [HITL required]   │   │
│  │  • get_workflow_status (queries Temporal)                            │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Curation Database Schema

### Existing Tables (no changes)

```sql
-- journal_curation, entity_curation_items, relationship_curation_items, span_curation_items
-- (already defined in curation_manager.py)
```

### New Tables

Following the existing pattern in `curation_manager.py` (JSON columns for flexibility):

```sql
-- Quote parsing curation (workflow-level tracking)
CREATE TABLE quote_workflow_curation (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    workflow_id TEXT NOT NULL UNIQUE,
    file_path TEXT NOT NULL,
    content_title TEXT,
    content_author TEXT,
    overall_status TEXT DEFAULT 'PENDING' CHECK (overall_status IN ('PENDING', 'COMPLETED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Quote items (individual quotes for curation)
CREATE TABLE quote_curation_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    uuid TEXT NOT NULL,
    workflow_id TEXT NOT NULL,
    original_data_json TEXT,  -- Quote object as JSON
    curated_data_json TEXT,   -- Edited version if accepted with changes
    status TEXT DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'ACCEPTED', 'REJECTED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    curated_at TIMESTAMP,
    FOREIGN KEY (workflow_id) REFERENCES quote_workflow_curation (workflow_id)
);

-- Concept extraction curation (workflow-level tracking)
CREATE TABLE concept_workflow_curation (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    workflow_id TEXT NOT NULL UNIQUE,
    content_uuid TEXT NOT NULL,
    overall_status TEXT DEFAULT 'PENDING_CONCEPTS' 
        CHECK (overall_status IN ('PENDING_CONCEPTS', 'CONCEPTS_DONE', 'PENDING_RELATIONS', 'COMPLETED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Concept items (individual concepts for curation)
CREATE TABLE concept_curation_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    uuid TEXT NOT NULL,
    workflow_id TEXT NOT NULL,
    original_data_json TEXT,  -- CandidateConcept as JSON (title, concept, analysis, source_quote_uuids)
    curated_data_json TEXT,
    status TEXT DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'ACCEPTED', 'REJECTED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    curated_at TIMESTAMP,
    FOREIGN KEY (workflow_id) REFERENCES concept_workflow_curation (workflow_id)
);

-- Concept relation items
CREATE TABLE concept_relation_curation_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    uuid TEXT NOT NULL,
    workflow_id TEXT NOT NULL,
    original_data_json TEXT,  -- Relation as JSON (source_id, target_id, type, explanation)
    curated_data_json TEXT,
    status TEXT DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'ACCEPTED', 'REJECTED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    curated_at TIMESTAMP,
    FOREIGN KEY (workflow_id) REFERENCES concept_workflow_curation (workflow_id)
);

-- Inbox classification curation
CREATE TABLE inbox_classification_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    uuid TEXT NOT NULL,
    workflow_id TEXT NOT NULL,
    original_data_json TEXT,  -- { source_path, target_folder, note_title, reason }
    curated_data_json TEXT,   -- { edited_target_folder } if user changes destination
    status TEXT DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'ACCEPTED', 'REJECTED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    curated_at TIMESTAMP
);

-- Notifications
CREATE TABLE notifications (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    uuid TEXT NOT NULL,
    workflow_id TEXT,
    workflow_type TEXT,  -- 'journal', 'quote_parsing', 'concept_extraction', 'inbox_classification'
    notification_type TEXT NOT NULL,  -- 'workflow_started', 'curation_pending', 'workflow_completed', 'workflow_failed'
    title TEXT NOT NULL,
    message TEXT,
    payload_json TEXT,  -- JSON for additional data
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    read_at TIMESTAMP,
    dismissed_at TIMESTAMP
);

-- Indexes for performance
CREATE INDEX idx_quote_items_workflow_status ON quote_curation_items (workflow_id, status);
CREATE INDEX idx_concept_items_workflow_status ON concept_curation_items (workflow_id, status);
CREATE INDEX idx_concept_relation_items_workflow ON concept_relation_curation_items (workflow_id, status);
CREATE INDEX idx_inbox_items_workflow_status ON inbox_classification_items (workflow_id, status);
CREATE INDEX idx_notifications_workflow ON notifications (workflow_id);
CREATE INDEX idx_notifications_unread ON notifications (read_at) WHERE read_at IS NULL;
```

---

## Rework Tasks

### Task Group 1 — Demote minerva_agent (remove write tools)

**Goal:** Replace `deepagents.create_deep_agent` with `langchain.agents.create_agent`, keeping only read-only tools plus workflow-launching tools.

**Key Changes:**
- Remove deepagents dependency entirely
- Drop TodoListMiddleware and SubAgentMiddleware (simplify agent)
- Use HumanInTheLoopMiddleware for workflow launch confirmation
- LangGraph API Server handles checkpointing automatically (no manual config needed)

**Before:**
```python
from deepagents import create_deep_agent
from deepagents.backends import FilesystemBackend

graph = create_deep_agent(
    model=model_pro,
    system_prompt=vault_assistant_prompt,
    backend=FilesystemBackend(root_dir=VAULT_PATH, virtual_mode=True),
)
```

**After:**
```python
from langchain.agents import create_agent
from langchain.agents.middleware import HumanInTheLoopMiddleware

# Read-only tools (no approval needed)
read_file_tool = create_read_file_tool(vault_path=VAULT_PATH)
list_dir_tool = create_list_dir_tool(vault_path=VAULT_PATH)
glob_tool = create_glob_tool(vault_path=VAULT_PATH)
grep_tool = create_grep_tool(vault_path=VAULT_PATH)

# Workflow-launching tools (require HITL confirmation)
start_quote_parsing_tool = create_start_quote_parsing_tool()
start_concept_extraction_tool = create_start_concept_extraction_tool()
start_inbox_classification_tool = create_start_inbox_classification_tool()
get_workflow_status_tool = create_get_workflow_status_tool()

graph = create_agent(
    model=model_pro,
    tools=[
        read_file_tool, list_dir_tool, glob_tool, grep_tool,
        start_quote_parsing_tool, start_concept_extraction_tool,
        start_inbox_classification_tool, get_workflow_status_tool,
    ],
    system_prompt=vault_assistant_prompt,
    middleware=[
        HumanInTheLoopMiddleware(
            interrupt_on={
                "start_quote_parsing": True,
                "start_concept_extraction": True,
                "start_inbox_classification": True,
            },
            description_prefix="Confirm workflow launch",
        ),
    ],
    # No checkpointer needed - LangGraph API Server handles this automatically
)
```

**Subtasks:**
- [ ] Create `tools/read_file.py` — read file from vault
- [ ] Create `tools/list_dir.py` — list directory contents
- [ ] Create `tools/glob.py` — glob pattern matching
- [ ] Create `tools/grep.py` — content search
- [ ] Create `tools/start_quote_parsing.py` — launches QuoteParsingWorkflow
- [ ] Create `tools/start_concept_extraction.py` — launches ConceptExtractionWorkflow
- [ ] Create `tools/start_inbox_classification.py` — launches InboxClassificationWorkflow
- [ ] Create `tools/get_workflow_status.py` — queries Temporal for workflow state
- [ ] Update `agent.py` to use `create_agent` with HITL middleware
- [ ] Update `langgraph.json` configuration
- [ ] Remove deepagents from `pyproject.toml`

### Task Group 2 — Migrate quote_parse_graph to Temporal

**Goal:** Convert quote parsing from LangGraph to Temporal workflow.

**Target Workflow:**
```
QuoteParsingWorkflow:
│
├─ Activity: scan_markdown_file(file_path)
│   └─ Reads file, extracts "# Citas" section
│   └─ Returns { raw_quotes, metadata }
│
├─ Activity: parse_quotes_with_llm(raw_quotes)
│   └─ LLM structures quotes, identifies author
│   └─ Returns List[ParsedQuote]
│
├─ Activity: enrich_with_web_search(content_info)
│   └─ Web search for book/author info
│   └─ Returns enriched Content metadata
│
├─ Activity: submit_quote_curation(file_path, quotes, content)
│   └─ Writes to quote_curation_items table
│
├─ Activity: wait_for_quote_curation(workflow_id)
│   └─ Polls until all quotes approved/rejected
│   └─ Returns { approved_quotes, content }
│
└─ Activity: write_quotes_to_graph(approved_quotes, content)
    └─ Creates Content, Quote, Author, QUOTED_IN, AUTHORED_BY
```

**Subtasks:**
- [ ] Create `QuoteParsingWorkflow` class
- [ ] Create activities: `scan_markdown_file`, `parse_quotes_with_llm`, `enrich_with_web_search`
- [ ] Create activities: `submit_quote_curation`, `wait_for_quote_curation`, `write_quotes_to_graph`
- [ ] Add API endpoints for quote curation
- [ ] Add Vue.js views for quote review
- [ ] Register workflow with Temporal worker

### Task Group 3 — Migrate concept_extraction_graph to Temporal

**Goal:** Convert concept extraction from LangGraph to Temporal workflow.

**Target Workflow:**
```
ConceptExtractionWorkflow:
│
├─ PHASE 1: Extraction Loop (up to 10 iterations)
│   │
│   ├─ Activity: load_content_and_quotes(content_uuid)
│   │   └─ Fetches Content and Quote nodes from Neo4j
│   │   └─ Returns { content, quotes }
│   │
│   ├─ Activity: extract_candidate_concepts(quotes, user_suggestions)
│   │   └─ LLM extracts candidate concepts from quotes
│   │   └─ Returns List[CandidateConcept]
│   │
│   ├─ Activity: detect_duplicates(candidates)
│   │   └─ Vector search + LLM to find duplicates
│   │   └─ Returns { novel_concepts, existing_with_new_quotes }
│   │
│   ├─ Activity: discover_relations(novel_concepts)
│   │   └─ LLM finds relations between concepts
│   │   └─ Returns List[ConceptRelation]
│   │
│   ├─ Activity: self_critique(concepts, relations)
│   │   └─ LLM evaluates quality against checklist
│   │   └─ Returns { passes: bool, issues: List[Issue] }
│   │
│   └─ Activity: refine_extraction(concepts, relations, issues)
│       └─ LLM addresses critique issues
│       └─ Returns refined { concepts, relations }
│       └─ Workflow loops back to self_critique if !passes (max 10x)
│
├─ PHASE 2: Human Curation
│   │
│   ├─ Activity: submit_concept_curation(content_uuid, concepts, relations)
│   │   └─ Writes to concept_curation_items and concept_relation_curation_items
│   │
│   └─ Activity: wait_for_concept_curation(workflow_id)
│       └─ Polls until all items approved/rejected (7-day timeout)
│       └─ Returns { approved_concepts, approved_relations }
│
└─ PHASE 3: Commit
    │
    ├─ Activity: write_concepts_to_graph(approved_concepts, approved_relations)
    │   └─ Creates Concept nodes in Neo4j
    │   └─ Creates SUPPORTS relations (Quote → Concept)
    │   └─ Creates concept-to-concept relations
    │
    ├─ Activity: create_obsidian_files(approved_concepts, approved_relations)
    │   └─ Writes zettel markdown files to Obsidian vault
    │
    └─ Activity: mark_content_processed(content_uuid)
        └─ Sets processed_date on Content node
```

**Error Handling (mirroring journal workflow):**
```python
retry_policy = RetryPolicy(
    initial_interval=timedelta(seconds=2),
    maximum_attempts=3,
    backoff_coefficient=2.0,
    maximum_interval=timedelta(minutes=5),
)

# Curation wait: 7-day timeout, heartbeat every 2 min
schedule_to_close_timeout=timedelta(days=7)
heartbeat_timeout=timedelta(minutes=2)
```

**Subtasks:**
- [ ] Create `ConceptExtractionWorkflow` class (new file: `concept_extraction_workflow.py`)
- [ ] Create activity: `load_content_and_quotes` — fetch from Neo4j
- [ ] Create activity: `extract_candidate_concepts` — LLM extraction
- [ ] Create activity: `detect_duplicates` — vector search + LLM dedup
- [ ] Create activity: `discover_relations` — LLM relation finding
- [ ] Create activity: `self_critique` — LLM quality check
- [ ] Create activity: `refine_extraction` — LLM refinement
- [ ] Create activity: `submit_concept_curation` — write to curation DB
- [ ] Create activity: `wait_for_concept_curation` — poll until done
- [ ] Create activity: `write_concepts_to_graph` — Neo4j writes
- [ ] Create activity: `create_obsidian_files` — filesystem writes
- [ ] Create activity: `mark_content_processed` — update Content node
- [ ] Implement Phase 1 loop logic in workflow (max 10 iterations)
- [ ] Add API endpoints for concept curation
- [ ] Add Vue.js views for concept review
- [ ] Register workflow with Temporal worker
- [ ] Remove/deprecate zettel's LangGraph implementation

### Task Group 4 — Add Inbox Classification Workflow

**Goal:** Create a workflow that classifies notes in the Obsidian inbox and moves them to appropriate folders.

**User Story:**
> "I have notes in `01 - Inbox/` that need to be organized. The agent should analyze each note, suggest which folder it belongs in (e.g., `03 - Projects/`, `04 - Areas/`, `08 - Ideas/`), and after I approve, move the files."

**Target Workflow:**
```
InboxClassificationWorkflow:
│
├─ Activity: scan_inbox(inbox_path)
│   └─ Lists all files in inbox folder
│   └─ Returns List[InboxFile]
│
├─ Activity: classify_note(file_path, vault_structure)
│   └─ Reads note content
│   └─ LLM suggests target folder based on content and vault structure
│   └─ Returns { target_folder, reason }
│
├─ Activity: submit_classification_curation(classifications)
│   └─ Writes to inbox_classification_items table
│
├─ Activity: wait_for_classification_curation(workflow_id)
│   └─ Polls until all items approved/rejected
│   └─ Returns List[ApprovedMove]
│
└─ Activity: execute_moves(approved_moves)
    └─ Moves files from inbox to target folders
    └─ Updates any internal links if needed
```

**Subtasks:**
- [ ] Create `InboxClassificationWorkflow` class
- [ ] Create activity: `scan_inbox` — list inbox files
- [ ] Create activity: `classify_note` — LLM classification
- [ ] Create activity: `submit_classification_curation` — write to curation DB
- [ ] Create activity: `wait_for_classification_curation` — poll until done
- [ ] Create activity: `execute_moves` — move files
- [ ] Add API endpoints for classification curation
- [ ] Add Vue.js views for classification review
- [ ] Create `start_inbox_classification` tool for agent

### Task Group 5 — Extend Curation UI

**Goal:** Add views for all new curation types.

**New Routes:**
- `/curation/quotes` — List pending quote extractions
- `/curation/quotes/:workflowId` — Review quotes for a specific file
- `/curation/concepts` — List pending concept extractions
- `/curation/concepts/:workflowId` — Review concepts for a specific content
- `/curation/inbox` — List pending inbox classifications
- `/curation/inbox/:workflowId` — Review classification suggestions

**Subtasks:**
- [ ] Create Vue components for quote review
- [ ] Create Vue components for concept review
- [ ] Create Vue components for inbox classification review
- [ ] Add bulk accept/reject functionality
- [ ] Add edit capability for classifications (change target folder)

### Task Group 6 — Notifications (Do Last)

**Goal:** Add notifications and display in both UIs.

**Subtasks:**
- [ ] Add notifications table (schema above)
- [ ] Emit notifications from Temporal activities
- [ ] Add `GET /api/notifications` endpoint
- [ ] Add `POST /api/notifications/{id}/read` endpoint
- [ ] Add notifications panel to curation UI
- [ ] Add notifications indicator to minerva-desktop

---

## Technical Details

### Workflow ID Format

| Workflow | ID Format | Example |
|----------|-----------|---------|
| JournalProcessing | `journal-{date}-{uuid}` | `journal-2026-02-03-abc123` |
| QuoteParsing | `quote-{uuid}` | `quote-def456` |
| ConceptExtraction | `concept-{content_uuid}` | `concept-ghi789` |
| InboxClassification | `inbox-{timestamp}` | `inbox-1706990400` |

### Curation DB Schema Pattern

New tables follow the same pattern as existing `curation_manager.py`:
- `original_data_json` / `curated_data_json` for flexibility
- Status values: `PENDING`, `ACCEPTED`, `REJECTED`
- `INTEGER PRIMARY KEY AUTOINCREMENT` instead of `TEXT PRIMARY KEY`
- Workflow-level tables for overall status tracking

See full schema in "Curation Database Schema" section above.

### QuoteParsingWorkflow Input

The current `quote_parse_graph` requires `file_path`, `author`, `title` as explicit inputs. For the Temporal workflow:

**Option A (keep explicit):** User must provide author/title when launching
```python
start_quote_parsing(file_path="...", author="Lenin", title="Obras Completas")
```

**Option B (LLM extracts):** Extract from file frontmatter or first heading
```python
start_quote_parsing(file_path="...")  # author/title extracted from file
```

**Decision:** Use Option A for now (matches current behavior). Can add auto-extraction later.

### Temporal Client in Tools

Tools need access to Temporal client to start workflows:

```python
# tools/start_concept_extraction.py
from temporalio.client import Client
from minerva_backend.processing.concept_extraction_workflow import ConceptExtractionWorkflow

async def start_concept_extraction(content_uuid: str) -> str:
    """Start concept extraction workflow for a content item."""
    client = await Client.connect("localhost:7233")
    
    workflow_id = f"concept-{content_uuid}"
    await client.start_workflow(
        ConceptExtractionWorkflow.run,
        args=[content_uuid],
        id=workflow_id,
        task_queue="minerva-pipeline",
    )
    
    return f"Started workflow {workflow_id}"
```

### Worker Registration

Update `temporal_orchestrator.py` to register new workflows:

```python
# Add imports
from minerva_backend.processing.quote_parsing_workflow import QuoteParsingWorkflow
from minerva_backend.processing.concept_extraction_workflow import ConceptExtractionWorkflow
from minerva_backend.processing.inbox_classification_workflow import InboxClassificationWorkflow

# Update worker
worker = Worker(
    client,
    task_queue="minerva-pipeline",
    workflows=[
        JournalProcessingWorkflow,
        QuoteParsingWorkflow,        # NEW
        ConceptExtractionWorkflow,   # NEW
        InboxClassificationWorkflow, # NEW
    ],
    activities=[...],
)
```

### LLM Model Selection

Following the pattern from existing zettel code:

| Activity | Model | Reason |
|----------|-------|--------|
| `extract_candidate_concepts` | gemini-2.5-pro | Complex extraction |
| `detect_duplicates` | gemini-2.5-pro | Semantic understanding |
| `discover_relations` | gemini-2.5-pro | Relationship reasoning |
| `self_critique` | gemini-2.5-pro | Deep analysis |
| `refine_extraction` | gemini-2.5-pro | Synthesis |
| `classify_note` | gemini-2.5-flash | Simpler classification |
| `parse_quotes_with_llm` | gemini-2.5-flash-lite | Simple parsing |
| `enrich_with_web_search` | gemini-2.5-flash-lite | Web search queries |

### API Endpoints for New Curation Types

Following the existing pattern in `curation.py`:

```python
# Quote curation
GET  /api/curation/quotes/pending
POST /api/curation/quotes/{workflow_id}/complete
POST /api/curation/quotes/{workflow_id}/{quote_id}  # action: accept/reject

# Concept curation
GET  /api/curation/concepts/pending
POST /api/curation/concepts/{workflow_id}/complete
POST /api/curation/concepts/{workflow_id}/{concept_id}

# Inbox classification curation
GET  /api/curation/inbox/pending
POST /api/curation/inbox/{workflow_id}/complete
POST /api/curation/inbox/{workflow_id}/{item_id}
```

### langgraph.json Updates

**minerva_agent/langgraph.json (after rework):**
```json
{
  "$schema": "https://langgra.ph/schema.json",
  "dependencies": ["."],
  "graphs": {
    "minerva_agent": "./src/minerva_agent/agent.py:graph"
  },
  "env": ".env"
}
```
(No change to structure, but `agent.py` internals change to use `create_agent`)

**zettel/langgraph.json (deprecated):**
- Keep file but add comment that workflows are now in Temporal
- Or delete entirely after migration is complete

### Deprecation Plan

1. **Phase 1:** Implement Temporal workflows alongside LangGraph graphs
2. **Phase 2:** Switch minerva_agent to use Temporal-launching tools
3. **Phase 3:** Remove LangGraph graphs from zettel, keep only as reference
4. **Phase 4:** Clean up - remove zettel folder or archive it

### Error Handling Details

Following journal workflow patterns:

| Scenario | Behavior |
|----------|----------|
| Activity fails after 3 retries | Workflow fails, visible in Temporal UI |
| Curation times out (7 days) | Workflow fails with timeout error |
| All items rejected | Workflow completes with empty result (no writes) |
| Partial approval | Only approved items are written |

---

## HITL in Chat UI

The minerva-desktop app (based on agent-chat-ui) has **built-in support for HITL interrupts**.

**How it works:**

1. Agent calls `start_inbox_classification(...)` tool
2. `HumanInTheLoopMiddleware` intercepts and emits interrupt
3. Chat UI detects interrupt via `isAgentInboxInterruptSchema()`
4. Chat UI renders `ThreadView` component with approve/reject buttons
5. User clicks approve
6. Chat UI calls `stream.submit({ decision: { type: "approve" } })`
7. Agent resumes and calls Temporal to start workflow

**No additional implementation needed** — this works out of the box with the middleware configuration.

---

## Implementation Order

1. **Task Group 1** — Demote minerva_agent (quick win, foundation for everything)
2. **Task Group 4** — Inbox Classification Workflow (new capability, simpler than zettel)
3. **Task Group 2** — Quote Parsing Workflow (prerequisite for concept extraction)
4. **Task Group 3** — Concept Extraction Workflow (biggest effort, core value)
5. **Task Group 5** — Extend Curation UI (needed for all workflows)
6. **Task Group 6** — Notifications (polish)

---

## Testing Strategy

### Unit Tests

Each activity should have unit tests with mocked dependencies:

```python
# tests/test_concept_extraction_activities.py
async def test_extract_candidate_concepts():
    """Test LLM extraction with mocked LLM response."""
    
async def test_detect_duplicates_no_matches():
    """Test duplicate detection when no similar concepts exist."""

async def test_self_critique_passes():
    """Test quality check returns passes=True for good concepts."""
```

### Integration Tests

Test full workflow with real Temporal (dev server):

```python
# tests/integration/test_concept_extraction_workflow.py
async def test_concept_extraction_full_flow():
    """
    1. Start workflow with test content
    2. Verify extraction activities complete
    3. Mock curation approval
    4. Verify writes to Neo4j
    """
```

### Curation Manager Tests

Extend existing `tests/test_curation_manager.py`:

```python
async def test_queue_concepts_for_curation():
    """Test adding concepts to curation queue."""

async def test_accept_concept():
    """Test accepting a concept updates status."""

async def test_get_accepted_concepts():
    """Test retrieving approved concepts."""
```

### Agent Tool Tests

```python
# tests/test_agent_tools.py
async def test_start_concept_extraction_tool():
    """Test tool correctly starts Temporal workflow."""

async def test_read_file_tool_sandboxed():
    """Test tool only reads from vault path."""
```

---

## Acceptance Criteria (Definition of Done)

This rework is complete when:

- [ ] `minerva_agent` has no write-capable tools (only read + workflow launchers)
- [ ] `quote_parse_graph` is replaced by QuoteParsingWorkflow (Temporal)
- [ ] `concept_extraction_graph` is replaced by ConceptExtractionWorkflow (Temporal)
- [ ] InboxClassificationWorkflow is implemented and working
- [ ] All workflows flow through: LLM → curation DB → curation UI → Temporal → writes
- [ ] Chat can launch workflows with HITL confirmation
- [ ] Curation UI can review quotes, concepts, and classifications
- [ ] All writes occur inside Temporal activities
- [ ] *"Why did this happen?"* can be answered from Temporal history + curation DB

---

## Non-Goals

This rework **does not** include:

- changing extraction logic (LLM prompts stay the same)
- changing entity schemas
- improving LLM quality
- adding workflows beyond the four listed

This is an **authority and permission refactor** only.

---

## Summary: Who Owns What

| Concern | Owner |
|---------|-------|
| Conversation, Q&A | Chat (LangGraph agent) |
| Launching workflows | Chat (via tool calls, with HITL confirmation) |
| Workflow orchestration | Temporal |
| Human approval | Curation UI |
| Source of truth | Curation DB |
| Mutations (writes) | Temporal activities only |

---

## Guiding Principle

> **The system must behave correctly even if the LLM is wrong.**

If an LLM hallucination can cause side effects without flowing through Temporal and curation UI, the architecture is incorrect.
